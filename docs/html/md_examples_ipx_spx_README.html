<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>megadev: ipx_spx</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">megadev
   &#160;<span id="projectnumber">1</span>
   </div>
   <div id="projectbrief">A Sega Mega CD development framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ipx_spx </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is an example of loading a memory-resident master program (kernel) on either or both of the sides (Main and Sub) of the hardware. Once again taking a cue from Sonic CD, we call these resident programs the IPX and SPX, the "extended" IP and SP. They are loaded early on and remain in memory for the life of the program and provide commonly used functions for all the aspects of your game. In other words, this will be the "kernel" that we have discussed in the documentation.</p>
<p>The IPX will run on the Main side and SPX on the Sub side. As discussed in the modules readme, memory layout needs to be planned carefully, especially for the Main side where Work RAM is limited. In this example, we place the MMD loader and a minimal, temporary VINT handler in IP and the CDROM access API in SP. These are the major components necessary to get data loaded from the disc and then execute it. With that in place, we'll load the SPX and IPX and go from there.</p>
<p>The example here uses both an IPX and SPX, though you are free to use only one of the two on either side depending on your project.</p>
<h1><a class="anchor" id="autotoc_md127"></a>
IPX</h1>
<p>The IP is loaded automatically by the system on startup and is placed at the start of Work RAM, at 0xFF0000. The very first code it MUST run is the security code. That means the security code must begin at the start of your IP.</p>
<p>The IP must not exceed 3.5KB (3,584 bytes). That is the space allocated to it within the boot sector. Note that this does not include the security code, which fills an extra 1,412 bytes (for EU/US) or 342 bytes (for JP) of that space. What this means is that the IP has enough space to get things rolling, but that's about it.</p>
<p>This is where the IPX concept becomes helpful. The idea is to have the IP request the IPX from the SP side, and when it has been loaded, copy its entirety into Work RAM to overwrite the IP and reclaim the space of the now useless security code.</p>
<p>This is simple enough at a high level, but we have to keep in mind from where this copy code is running. That is, if the IP is copying to Work RAM and is also running from Work RAM, it's going to overwrite itself and everything will fall apart. The solution is quite simple, actually: setup the IPX as a proper module, with the correct destination and memory boundaries, and put the MMD exec code (which does the copy and the jump) right at the start of IPX. We'll then have the IP jump to the IPX entry in Work RAM. Jumping directly into the MMD exec will copy the full IPX into work RAM and jump to its main() entry point. Simple and elegant.</p>
<p>The IPX is now the main loop for the program, the "kernel" on the main side, loading and running modules depending on the global program mode.</p>
<p>This sort of architecture works well if each module is just going to run from Word RAM as-is. Things become a bit more tricky if you plan to actively transfer data from the Sub side via Word RAM during program execution. In particular, the scaling/rotation capabilities provided by the Mega CD unit requires transferring the graphics to the Main side and ultimately to the VDP via Word RAM. In these cases, you'll want the code to run from Work RAM. You may be able to put everything you need into the IPX, but if not, you can further map Work RAM and allocate space for loaded modules to run from there. This is what Sonic CD does: for most parts of the game, modules run directly from Word RAM. But for parts where the Sub side graphics functions are used (such as the rotation/scaling in the special stage), the module is run from Work RAM, in a space allocated seperately from the IPX.</p>
<h1><a class="anchor" id="autotoc_md128"></a>
SPX</h1>
<p>The SPX, while similar in concept, is a bit different. The usefulness of the IPX becomes clear when working with the hardware after a while: the IP in the boot sector is too small to have a significant amount of code/resources for use throughout the game and the security code is an ugly waste of space. The IPX solves this by being larger and overwriting the original IP.</p>
<p>The SP, however, can be quite large: it can be up to 28kb within the boot sector, which is plenty of space for code and some resources. Moreover, PRG-RAM has more than 7 times the usable space of Work RAM. We aren't squeezed for space and there is no unnecessary security code to overwrite. The real benefit of creating an SPX is the ability to write code in C instead of entirely in ASM.</p>
<p>Rather than overwriting the SP, we'll keep it where it is and "add on" to it with the SPX. Megadev allocates 16KB of space for the SP by default (though this is user definable), so we'll use that as the boundary. We'll load SPX at 16KB past the start of the user space in PRG-RAM, which begins at 0x6000.</p>
<p>Because both the SP and SPX are resident in memory, you may need to specify both the SP <em>and</em> SPX in the definition for subsequently loaded modules on the Sub side. This depends, of course, on if you use any of the functions within each domain. For example, the SP will almost certainly contain the CD-ROM access API. If you need to use it, you'll need to include SP in the definition file. However, if any CD-ROM access calls are wrapped in other functions within the SPX, then you will only need to include SPX.</p>
<h1><a class="anchor" id="autotoc_md129"></a>
Resident Module Reminder</h1>
<p>Code that remains resident in memory and will be referenced by modules need to a) be built first and b) be included as a reference when building the module. Part A is accomplished by declaring 'ipx' and 'spx' as resident modules within the project makefile. You can find this illustrated in the makefile for this project. Part B is done by specifying which resident module(s) will be referenced within the loaded module code within the def file. You can see this in any of the def files for the three 'ex' modules in this project. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
